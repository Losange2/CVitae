{% extends 'template.html.twig' %}

{% block title %}Cv{% endblock %}

{% block body %}
    <h1>Cv</h1>

    <table class="table">
        <tbody>
            <tr>
                <th style="text-align: center;">Titre</th>
            </tr>
            <tr>
                <td style="text-align: center;">{{ cv.Titre }}</td>
            </tr>
            <tr>
                <td>
                    {% set categories = {} %}
                    {% for point in cv.getLesPoints() %}
                        {% set cateId = 'cat_' ~ point.getLaCate().id %}
                        {% set cateName = point.getLaCate().libelle %}
                        {% if categories[cateId] is not defined %}
                            {% set categories = categories|merge({(cateId): {name: cateName, points: []}}) %}
                        {% endif %}
                        {% set categories = categories|merge({(cateId): {name: cateName, points: categories[cateId].points|merge([point])}}) %}
                    {% endfor %}
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
                        {% for cateId, category in categories %}
                            <div class="category" style="flex: 0 1 auto;">
                                <details {{ loop.first ? 'open' : '' }} onclick="document.querySelectorAll('details').forEach(d => { if(d !== this) d.removeAttribute('open'); })">
                                    <summary style="cursor: pointer; font-weight: bold; text-align: center;">{{ category.name }}</summary>
                                    <ul>
                                        {% for point in category.points %}
                                            <li>{{ point.libelle }}</li>
                                            <button class="btn" onclick="location.href='{{ path('app_point_edit', {'id': point.id}) }}'">edit</button>
                                            {{ include('point/_delete_form.html.twig', {'point': point}) }}
                                        {% endfor %}
                                    </ul>
                                </details>
                            </div>
                        {% endfor %}
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
{% if is_granted('ROLE_ADMIN') %}
    <a href="{{ path('app_cv_index') }}">back to list</a>

    <a href="{{ path('app_cv_edit', {'id': cv.id}) }}">edit</a>
    


    {{ include('cv/_delete_form.html.twig') }}

{% endif %}
{% if is_granted('ROLE_USER') and app.user == cv.getLeClient() %}
    <button class="btn" onclick="location.href='{{ path('app_cv_edit', {'id': cv.id}) }}'">edit</button>
    <form method="post" action="{{ path('app_creer_remplissage') }}" style="display:inline">
        <input type="hidden" name="cv_id" value="{{ cv.id }}">
        <button class="btn" type="submit">Add Point</button>
    </form>
    {{ include('cv/_delete_form.html.twig') }}
{% endif %}
{% endblock %}
